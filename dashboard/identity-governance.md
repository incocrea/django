# Identity Governance — `/identity-governance`

## Información General

La interfaz de Identity Governance permite gestionar el sistema de versionamiento, evolución y monitoreo de salud de la identidad de Django. Es el centro de control para las fases 10A-10D del pipeline de identidad: propuestas de evolución, simulaciones shadow (no-mutantes), snapshots de identidad, y monitoreo longitudinal de salud. Todas las operaciones de mutación requieren aprobación humana explícita — ningún cambio se aplica automáticamente.

La página organiza su funcionalidad en 4 tabs independientes: Versions (gestión de snapshots inmutables), Evolution (propuestas de evolución generadas automáticamente), Shadow Simulation (simulaciones paralelas de candidatos), e Identity Health (monitoreo longitudinal con señales de identidad).

---

## Información Presentada

### Tab 1: Versions (GitBranch icon)

#### Indicador de Perfil Activo
Banner superior que muestra la fuente del perfil de identidad activo:
- **Verde**: "Active profile loaded from snapshot: {id}…" — el perfil fue cargado desde un snapshot guardado en Postgres
- **Ámbar**: "No snapshot activated — profile loaded from persona.yaml" — el perfil se carga desde el archivo YAML (estado por defecto)

#### Lista de Versiones
Cada versión se muestra como un Card con:

| Elemento | Descripción |
|----------|-------------|
| **Version** | Número semántico `vX.Y.Z` con fuente monoespaciada |
| **StatusBadge** | Active (verde, Star), Invalidated (rojo, Ban), Rollback Marker (naranja, RotateCcw), Candidate (azul), Historical (gris) |
| **Evolution Source** | Badge outline mostrando el origen: `manual_snapshot`, `evolution_candidate`, `shadow_simulation`, `rollback_marker` |
| **Content Hash** | SHA-256 truncado a 12 chars (con tooltip completo) |
| **Timestamp** | Fecha de creación (created_at, db_created_at, o timestamp) |
| **Principal Name** | Nombre del principal asociado al snapshot |
| **Tags** | Badges de colores: stable (verde), canonical (púrpura), pre-training (cyan), post-training (naranja), experimental (amarillo), rollback_marker (rojo), custom (gris) |
| **Label** | Etiqueta descriptiva (ej: "Foundational Identity") |
| **Notes** | Notas en itálica debajo de la metadata |
| **Invalidation warning** | Banner rojo con "Invalidated by rollback (source: {id})" para versiones invalidadas |

#### Botones por Versión

| Botón | Visible cuando | Icono |
|-------|---------------|-------|
| **Activate** | No activa Y no invalidada | CheckCircle |
| **Active badge** | Es la versión activa | CheckCircle (badge no-interactivo) |
| **Rollback** | Más antigua que la activa, no invalidada, no rollback_marker | RotateCcw |
| **Delete** | No activa (incluye invalidadas) | Trash2 |

Fuente: `GET /identity/versions?limit=50`

### Tab 2: Evolution (Dna icon)

#### Descripción
"Evolution proposals generated by Phase 10A analysis. All require human approval."

#### Lista de Candidatos
Cada propuesta de evolución muestra:

| Elemento | Descripción |
|----------|-------------|
| **Interaction ID** | Font mono, truncado a 200px |
| **Status badge** | Candidate (accent-primary), Rejected (rojo), No Evolution (outline gris) |
| **RiskBadge** | low (verde), medium (amarillo), high (rojo) |
| **Metrics grid (2x4)** | Avg Similarity (%), Avg Confidence (%), Drift Rate (%, warning si >25%), Shift Magnitude (decimal) |
| **Similarity Trend** | TrendingUp (verde) o TrendingDown (rojo) con % |
| **Sustained High Confidence** | CheckCircle verde si true |
| **Proposed Version** | vX.Y.Z propuesto |
| **Timestamp** | Fecha de evaluación |

#### Botones por Candidato (solo si `evolution_candidate: true`)

| Botón | Acción | Icono |
|-------|--------|-------|
| **Shadow Sim** | Deshabilitado (placeholder), tooltip "Run shadow simulation first" | FlaskConical |
| **Approve** | Aprueba el candidato | CheckCircle |
| **Reject** | Rechaza el candidato | XCircle |

Fuente: `GET /identity/evolution?limit=20`

### Tab 3: Shadow Simulation (FlaskConical icon)

#### Descripción
"Non-mutating parallel identity simulations. Compare current vs candidate identity signals."

#### Lista de Simulaciones
Cada simulación muestra:

**Si fue skipped**: Card con opacidad reducida, badge "Skipped", y `skip_reason`

**Si ejecutada**:

| Elemento | Descripción |
|----------|-------------|
| **RiskGradeBadge** | safe (verde), cautious (amarillo), risky (naranja), destabilizing (rojo) |
| **Risk Score** | Porcentaje monoespaciado |
| **Timestamp** | Fecha de evaluación |
| **Tabla comparativa** | 4 métricas: Identity Similarity, Projected Confidence, Projected Drift Rate (warning si >25%), Risk Score (warning si >50%) |
| **Structural Diff** | Grid 3 columnas: Big Five Deltas (% por dimensión, ámbar si >10%), Values Overlap (% Jaccard), Communication Style Deltas (% por dimensión) |
| **Risk Assessment bar** | ShieldCheck (verde) si safe/cautious, ShieldAlert (rojo) si risky/destabilizing + texto descriptivo |

Fuente: `GET /identity/shadow?limit=20`

### Tab 4: Identity Health (Activity icon)

#### Descripción
"Longitudinal identity health monitoring. Purely observational — no mutation."

#### Banner Pre-Training
Si la versión activa tiene tag "pre-training": banner cyan con "Foundational Identity (Pre-Training Baseline)". Detectado via `GET /identity/versions?limit=1`.

#### Health Summary Card (Heart icon)

| Métrica | Formato | Warning si |
|---------|---------|-----------|
| **Instability** | % | > 50% |
| **Avg Similarity** | % | — |
| **Avg Confidence** | % | — |
| **Drift Rate** | % | > 25% |
| **High Severity** | % | > 20% |
| **Sustained Low Confidence** | Yes/No (rojo/blanco) | Yes |

**HealthStatusBadge**: stable (verde), monitor (amarillo), unstable (naranja), critical (rojo)

#### Gráficos de Señales
2 gráficos de barras CSS (sin dependencia de librería de charts):

1. **Identity Similarity**: barras púrpura/ámbar, línea discontinua de threshold a 0.78 (drift threshold), stats: Latest, Avg, Range, Trend (TrendingUp/Down/Minus)
2. **Confidence Score**: barras azules, mismos stats

Cada gráfico muestra hasta 50 señales (newest a la derecha). Barras ámbar cuando el valor cae bajo el threshold.

#### Tabla de Señales Recientes
Últimas 10 señales con columnas:
- **Time**: timestamp
- **Similarity**: % monoespaciado
- **Confidence**: % monoespaciado
- **Decision Align**: % monoespaciado
- **Memory Affinity**: % monoespaciado
- **Policy**: SeverityBadge (none gris, low verde, medium ámbar, high/critical rojo)

Fuente: `GET /identity/health?window_size=50`

---

## Acciones

### 1. Create Snapshot
- **Tipo**: Modal → API Call
- **Comportamiento**: Botón "Create Snapshot" (Camera icon) → abre `CreateSnapshotModal` (305 líneas). El modal contiene:
  - **Version**: Input de texto, validación regex `^v\d+\.\d+\.\d+$` (ej: v1.0.0). Si vacío, se auto-asigna
  - **Label**: Input de texto libre (ej: "Foundational Identity")
  - **Tags**: 5 tags predefinidos clickeables (stable, canonical, pre-training, post-training, experimental) + input para custom tags (lowercase, espacios → hyphens)
  - **Notes**: Input de texto libre
  
  Llama `POST /identity/snapshot` con `{version?, tags?, label?, notes?}`

- **Impacto en Django**: 
  - Crea un snapshot inmutable del `IdentityProfile` actual vía `IdentityVersionControl.create_snapshot()`
  - Genera un UUID version_id, timestamp ISO, SHA-256 content_hash
  - Deep-copy del profile_data (nunca referencia mutable)
  - Persiste en Postgres via `PersistenceRepository.store_identity_snapshot()`
  - Emite evento `identity.snapshot_created` via EventBus
  - El snapshot queda disponible para Activate/Rollback pero **NO se activa automáticamente**

### 2. Activate Version
- **Tipo**: ConfirmDialog (warning) → API Call
- **Comportamiento**: Botón "Activate" (CheckCircle) en versiones no-activas → confirmar → llama `POST /identity/activate/{id}`
- **Impacto en Django**:
  - **Pointer swap**: Cambia el perfil de identidad activo al snapshot seleccionado
  - El `IdentityManager` carga el `IdentityProfile` desde el snapshot
  - Todas las componentes de identidad del pipeline (enforcement, policy, memory bridge, decision modulation, etc.) usarán el nuevo perfil a partir de la siguiente interacción
  - **No invalida** ninguna otra versión — es reversible simplemente activando otra versión
  - Si la versión ya está activa: retorna `already_active: true` sin cambio de estado (idempotente, Phase 10D.1 fix D5)
  - Emite evento `identity.version_activated` con `{destructive: False}`

### 3. Rollback to Version
- **Tipo**: ConfirmDialog (danger) → API Call
- **Comportamiento**: Botón "Rollback" (RotateCcw, naranja) en versiones más antiguas que la activa → confirmar warning destructivo → llama `POST /identity/rollback/{id}`
- **Impacto en Django**: ⚠️ **OPERACIÓN DESTRUCTIVA**:
  - Activa la versión seleccionada como perfil de identidad
  - **Invalida permanentemente TODAS las versiones creadas después** del punto de rollback (marca `invalidated_by_rollback: true`)
  - Las versiones invalidadas **no pueden ser activadas** — quedan como registro histórico
  - Crea un "rollback marker" snapshot automático para auditoría
  - Emite evento `identity.version_rolled_back` con `{destructive: True}`
  - Afecta todas las componentes de identidad del pipeline (mismo efecto que Activate, pero con invalidación)

### 4. Delete Version
- **Tipo**: ConfirmDialog (danger) → API Call
- **Comportamiento**: Botón Delete (Trash2, rojo) en versiones no-activas → confirmar → llama `DELETE /identity/versions/{id}`
- **Impacto en Django**:
  - Elimina permanentemente el snapshot de Postgres
  - **No se permite eliminar la versión activa** — retorna HTTP 409 Conflict (Phase 10D.1 fix D4)
  - Si el snapshot tenía datos de evolución o shadow asociados, esos NO se eliminan (son registros independientes por interaction_id)

### 5. Approve Evolution Candidate
- **Tipo**: API Call directa
- **Comportamiento**: Botón "Approve" (CheckCircle) en candidatos de evolución → llama `POST /identity/evolution/{interactionId}/approve`
- **Impacto en Django**:
  - Crea un snapshot del candidato de evolución via `IdentityVersionControl.create_snapshot()` con `evolution_source='evolution_candidate'`
  - El snapshot incluye metadata de evolución (proposed_version, shift_magnitude, etc.)
  - Emite evento `identity.evolution_approved` via EventBus (Phase 10D.1 fix D2)
  - **NO activa automáticamente** el snapshot — el usuario debe activarlo manualmente desde el tab Versions
  - En la práctica: aprobar un candidato solo lo persiste como snapshot disponible

### 6. Reject Evolution Candidate
- **Tipo**: API Call directa
- **Comportamiento**: Botón "Reject" (XCircle, rojo) en candidatos → llama `POST /identity/evolution/{interactionId}/reject`
- **Impacto en Django**:
  - Marca el candidato como rechazado (`evolution_rejected: true`)
  - Emite evento `identity.evolution_rejected` via EventBus singleton (Phase 10D.1 fix D1 — corregido de `EventBus()` constructor roto a singleton compartido)
  - El candidato permanece visible como "Rejected" pero no puede ser aprobado
  - No afecta el perfil de identidad activo ni el pipeline

### 7. Refresh (en cada tab)
- **Tipo**: API Call de lectura
- **Comportamiento**: Botón RefreshCw en cada tab → recarga datos del tab correspondiente
- **Impacto en Django**: Solo lectura

---

## Información Técnica

| Aspecto | Detalle |
|---------|---------|
| **Ruta** | `/identity-governance` |
| **Archivo principal** | `dashboard/app/identity-governance/page.tsx` (65 líneas) |
| **Componentes** | `components/identity-governance/versions-tab.tsx` (543 ln), `evolution-tab.tsx` (288 ln), `shadow-tab.tsx` (282 ln), `health-tab.tsx` (382 ln), `create-snapshot-modal.tsx` (305 ln) |
| **Total líneas frontend** | ~1,865 |
| **APIs de lectura** | `GET /identity/versions?limit=50`, `GET /identity/evolution?limit=20`, `GET /identity/shadow?limit=20`, `GET /identity/health?window_size=50` |
| **APIs de escritura** | `POST /identity/snapshot`, `POST /identity/activate/{id}`, `POST /identity/rollback/{id}`, `DELETE /identity/versions/{id}`, `POST /identity/evolution/{id}/approve`, `POST /identity/evolution/{id}/reject` |
| **Total endpoints** | 11 (4 lectura + 6 escritura + DELETE) |
| **Estado** | React `useState` por tab (cada componente maneja su estado independiente) |
| **Carga** | Cada tab carga sus datos con `useEffect` + `useCallback` al montar |
| **Backend modules** | `src/identity/version_control.py` (710 ln), `src/identity/evolution.py` (600 ln), `src/identity/shadow_simulation.py` (528 ln), `src/identity/health_monitor.py` (320 ln), `src/identity/manager.py` (255 ln) |
| **Persistence** | `src/db/persistence.py` — `store_identity_snapshot()`, `get_identity_versions()`, `get_identity_version()`, `get_recent_identity_signals()` |
| **Governance hardening** | Phase 10D.1 — 5 defect fixes (D1-D5) en routes.py |
| **Iconos** | Dna, GitBranch, FlaskConical, Activity, Camera, CheckCircle, RotateCcw, RefreshCw, Clock, Hash, Star, Tag, Trash2, AlertTriangle, Ban, Heart, TrendingUp, TrendingDown, Minus, XCircle, ShieldCheck, ShieldAlert, ArrowRight, Loader2, X, Plus |

**Última actualización**: 2025-06-23
